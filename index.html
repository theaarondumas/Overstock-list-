<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Providence Holy Cross ‚Äì Overstock Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1b4f72" />

  <style>
    :root {
      --ok-bg: #e8f5e9;
      --ok-text: #2e7d32;
      --ok-border: #2e7d32;

      --low-bg: #fff8e1;
      --low-text: #ff6f00;
      --low-border: #ff6f00;

      --over-bg: #ffebee;
      --over-text: #b71c1c;
      --over-border: #b71c1c;

      --card-bg: #ffffff;
      --card-border: #dde2eb;
      --table-header-bg: #f3f4f8;
      --body-bg: #f0f2f7;
      --primary: #1b4f72;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--body-bg);
      color: #222;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
      color: var(--primary);
      font-size: 1.4rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }

    .top-row {
      max-width: 1100px;
      margin: 0 auto 10px auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 900px) {
      .top-row {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 320px 1fr;
        align-items: start;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--card-border);
      padding: 12px 14px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1rem;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 6px;
      border: 1px solid #c5cad5;
      padding: 6px 8px;
      font-size: 0.85rem;
      font-family: inherit;
      background: #fbfcff;
    }

    .form-group textarea {
      min-height: 48px;
      resize: vertical;
    }

    .hint {
      font-size: 0.7rem;
      color: #777;
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-secondary {
      background: #e0e3ec;
      color: #333;
    }

    .btn-danger {
      background: #b71c1c;
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      color: #555;
      border: 1px solid #c5cad5;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .filters select,
    .filters input {
      border-radius: 999px;
      border: 1px solid #c5cad5;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #fbfcff;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--card-border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #fff;
    }

    thead {
      background: var(--table-header-bg);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3ec;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .status-ok {
      background: var(--ok-bg);
      color: var(--ok-text);
      border-color: var(--ok-border);
    }

    .status-low {
      background: var(--low-bg);
      color: var(--low-text);
      border-color: var(--low-border);
    }

    .status-over {
      background: var(--over-bg);
      color: var(--over-text);
      border-color: var(--over-border);
    }

    .photo-thumb {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .no-photo {
      font-size: 0.7rem;
      color: #999;
    }

    .count-label {
      font-size: 0.75rem;
      color: #777;
    }

    .actions button {
      padding: 4px 8px;
      font-size: 0.72rem;
    }

    .small-text {
      font-size: 0.7rem;
      color: #777;
      margin-top: 4px;
    }

    /* Image modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop img {
      max-width: 96vw;
      max-height: 96vh;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    /* Power BI iframe */
    .pbi-frame {
      width: 100%;
      min-height: 260px;
      border: 0;
      border-radius: 8px;
      background: #000;
    }

    @media (min-width: 900px) {
      .pbi-frame {
        min-height: 340px;
      }
    }

    .sync-status {
      font-size: 0.72rem;
      margin-top: 4px;
      color: #555;
    }

    .sync-status.ok {
      color: #2e7d32;
    }

    .sync-status.error {
      color: #b71c1c;
    }

    .sync-meta {
      font-size: 0.7rem;
      color: #777;
    }
  </style>
</head>
<body>
  <h1>Providence Holy Cross ‚Äì Overstock Tracker</h1>
  <div class="subtitle">
    Log overstock by department, sync to a central database, and monitor in Power BI.
  </div>

  <!-- TOP: Sync + Power BI -->
  <div class="top-row">
    <div class="card">
      <h2>Sync to Central Database</h2>
      <div class="small-text">
        This sends your overstock list from this device to a secure API (set up by IT).
        Power BI connects to that database so leaders can see system-wide overstock.
      </div>

      <div class="btn-row" style="margin-top:10px;">
        <button type="button" class="btn-primary" id="sync-btn">
          Sync All Items to Server
        </button>
        <button type="button" class="btn-ghost" id="export-btn-top">
          Export CSV (local backup)
        </button>
      </div>

      <div id="sync-status" class="sync-status">
        Not synced yet.
      </div>
      <div class="sync-meta">
        Last successful sync: <span id="last-sync">‚Äì</span>
      </div>
    </div>

    <div class="card">
      <h2>Leadership Dashboard (Power BI)</h2>
      <div class="small-text">
        IT / BI can embed a secure Power BI report here (not "publish to web").
        Replace the <code>src</code> in the iframe via code or by editing this file.
      </div>
      <!-- üîê IT: set src to a secure Power BI embed URL -->
      <iframe
        id="pbi-report"
        class="pbi-frame"
        src=""
        title="Overstock Power BI Report"
      ></iframe>
      <div class="small-text">
        If this area is blank, the Power BI embed URL has not been configured yet.
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT: form + table -->
  <div class="layout">
    <!-- LEFT: form -->
    <div class="card">
      <h2 id="form-title">Add New Item</h2>
      <div class="small-text">
        Fill this out while you're in the supply room. Data saves locally and can be synced.
      </div>

      <form id="item-form">
        <input type="hidden" id="edit-index" value="" />

        <div class="form-grid">
          <div class="form-group">
            <label for="department">Department</label>
            <select id="department" required>
              <option value="">Select...</option>
              <option>2 SOUTH</option>
              <option>2 EAST</option>
              <option>3 NORTH</option>
              <option>ICU</option>
              <option>ED</option>
              <option>OR</option>
              <option>Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="location">Supply Location (Room/Shelf)</label>
            <input
              type="text"
              id="location"
              placeholder="e.g., Core A ‚Äì Shelf 2"
            />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="item-name">Item Description</label>
            <input
              type="text"
              id="item-name"
              placeholder="e.g., 4x4 Gauze, 18G IV Catheter"
              required
            />
          </div>

          <div class="form-group">
            <label for="item-number">Vendor / Item # / Barcode</label>
            <input
              type="text"
              id="item-number"
              placeholder="Scan or type number"
            />
            <div class="hint">
              You can type the number or scan using your phone's camera app.
            </div>
          </div>

          <div class="form-group">
            <label for="quantity">Qty on Hand</label>
            <input
              type="number"
              id="quantity"
              min="0"
              placeholder="e.g., 45"
              required
            />
          </div>

          <div class="form-group">
            <label for="par-level">Target / PAR Qty</label>
            <input
              type="number"
              id="par-level"
              min="0"
              placeholder="e.g., 20"
              required
            />
            <div class="hint">Used to calculate LOW vs OVERSTOCK.</div>
          </div>

          <div class="form-group">
            <label for="expiration">Expiration Date (optional)</label>
            <input type="date" id="expiration" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="notes">Notes (optional)</label>
            <textarea
              id="notes"
              placeholder="e.g., Move to 2 EAST first, box slightly damaged‚Ä¶"
            ></textarea>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="photo-input">Item Photo (optional)</label>
            <input
              type="file"
              id="photo-input"
              accept="image/*"
              capture="environment"
            />
            <div class="hint">
              On mobile this should open the back camera. Take a quick photo of
              the box, label, or shelf.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn-primary" id="save-btn">
            Save Item
          </button>
          <button type="button" class="btn-secondary" id="clear-btn">
            Clear Form
          </button>
          <button type="button" class="btn-ghost" id="reset-all-btn">
            Reset Local Data
          </button>
        </div>
      </form>
    </div>

    <!-- RIGHT: table -->
    <div class="card">
      <h2>Overstock List</h2>

      <div class="filters">
        <select id="filter-dept">
          <option value="">All Departments</option>
          <option>2 SOUTH</option>
          <option>2 EAST</option>
          <option>3 NORTH</option>
          <option>ICU</option>
          <option>ED</option>
          <option>OR</option>
          <option>Other</option>
        </select>

        <input
          type="text"
          id="search-text"
          placeholder="Search item, vendor #, notes..."
        />

        <span class="count-label">
          Items: <span id="item-count">0</span>
        </span>

        <button type="button" class="btn-ghost" id="export-btn">
          Export CSV
        </button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Dept</th>
              <th>Item</th>
              <th>Qty / PAR</th>
              <th>Status</th>
              <th>Photo</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="items-body">
          </tbody>
        </table>
      </div>

      <div class="small-text">
        Local data stays in this browser until you reset. Use Sync to send a copy
        to the central database for Power BI.
      </div>
    </div>
  </div>

  <!-- Image modal -->
  <div class="modal-backdrop" id="image-modal">
    <img id="modal-image" src="" alt="Item photo" />
  </div>

  <script>
    /**********************
     * CONFIG (IT to edit)
     **********************/

    // üîê IT: replace this with your secure API endpoint
    // Example: "https://YOUR-FUNCTION-APP.azurewebsites.net/api/overstock/ingest"
    const API_ENDPOINT = "";

    // üîê IT / BI: set a secure Power BI embed URL here if you want via JS instead of hard-coded in HTML
    const POWER_BI_EMBED_URL = ""; // e.g. "https://app.powerbi.com/reportEmbed?reportId=...&groupId=..."

    /**********************
     * LOCAL APP LOGIC
     **********************/

    const STORAGE_KEY = "phc_overstock_items_v2";
    const LAST_SYNC_KEY = "phc_overstock_last_sync";

    let items = [];
    let photoDataPending = null;
    let isSyncInProgress = false;

    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        items = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error loading items:", e);
        items = [];
      }

      const last = localStorage.getItem(LAST_SYNC_KEY);
      if (last) {
        document.getElementById("last-sync").textContent = last;
        const statusEl = document.getElementById("sync-status");
        statusEl.textContent = "Last sync succeeded.";
        statusEl.classList.add("ok");
      }

      if (POWER_BI_EMBED_URL) {
        const iframe = document.getElementById("pbi-report");
        iframe.src = POWER_BI_EMBED_URL;
      }
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function computeStatus(item) {
      const qty = Number(item.quantity || 0);
      const par = Number(item.parLevel || 0);

      if (!par && !qty) return { label: "OK", className: "status-ok" };
      if (par === 0) return { label: "OK", className: "status-ok" };

      if (qty < par) return { label: "LOW", className: "status-low" };
      if (qty > par) return { label: "OVERSTOCK", className: "status-over" };

      return { label: "OK", className: "status-ok" };
    }

    function applyFilters(baseItems) {
      const deptFilter = document.getElementById("filter-dept").value.trim();
      const searchText = document
        .getElementById("search-text")
        .value.trim()
        .toLowerCase();

      return baseItems.filter((item) => {
        if (deptFilter && item.department !== deptFilter) return false;

        if (searchText) {
          const blob = (
            (item.department || "") +
            " " +
            (item.itemName || "") +
            " " +
            (item.itemNumber || "") +
            " " +
            (item.notes || "") +
            " " +
            (item.location || "")
          )
            .toLowerCase()
            .includes(searchText);

          if (!blob) return false;
        }

        return true;
      });
    }

    function renderTable() {
      const tbody = document.getElementById("items-body");
      tbody.innerHTML = "";

      const filtered = applyFilters(items);
      document.getElementById("item-count").textContent = filtered.length;

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "No items logged yet.";
        td.style.textAlign = "center";
        td.style.color = "#777";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach((item) => {
        const tr = document.createElement("tr");

        const tdDept = document.createElement("td");
        tdDept.innerHTML = `
          <div>${item.department || ""}</div>
          <div class="small-text">${item.location || ""}</div>
        `;
        tr.appendChild(tdDept);

        const tdItem = document.createElement("td");
        tdItem.innerHTML = `
          <div><strong>${item.itemName || ""}</strong></div>
          <div class="small-text">${item.itemNumber || ""}</div>
        `;
        tr.appendChild(tdItem);

        const tdQty = document.createElement("td");
        tdQty.innerHTML = `
          <div>${item.quantity ?? ""} / ${item.parLevel ?? ""}</div>
          ${
            item.expiration
              ? `<div class="small-text">Exp: ${item.expiration}</div>`
              : ""
          }
        `;
        tr.appendChild(tdQty);

        const tdStatus = document.createElement("td");
        const { label, className } = computeStatus(item);
        const span = document.createElement("span");
        span.className = "status-pill " + className;
        span.textContent = label;
        tdStatus.appendChild(span);
        tr.appendChild(tdStatus);

        const tdPhoto = document.createElement("td");
        if (item.photoData) {
          const img = document.createElement("img");
          img.src = item.photoData;
          img.className = "photo-thumb";
          img.title = "Tap to enlarge";
          img.addEventListener("click", () => openPhotoModal(item.photoData));
          tdPhoto.appendChild(img);
        } else {
          const spanNo = document.createElement("span");
          spanNo.className = "no-photo";
          spanNo.textContent = "No photo";
          tdPhoto.appendChild(spanNo);
        }
        tr.appendChild(tdPhoto);

        const tdNotes = document.createElement("td");
        tdNotes.textContent = item.notes || "";
        tr.appendChild(tdNotes);

        const tdActions = document.createElement("td");
        tdActions.className = "actions";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn-secondary";
        btnEdit.textContent = "Edit";
        btnEdit.addEventListener("click", () => startEditItem(item.id));
        tdActions.appendChild(btnEdit);

        const btnDelete = document.createElement("button");
        btnDelete.type = "button";
        btnDelete.className = "btn-danger";
        btnDelete.style.marginLeft = "4px";
        btnDelete.textContent = "Del";
        btnDelete.addEventListener("click", () => deleteItem(item.id));
        tdActions.appendChild(btnDelete);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    function clearForm() {
      document.getElementById("item-form").reset();
      document.getElementById("edit-index").value = "";
      document.getElementById("form-title").textContent = "Add New Item";
      document.getElementById("save-btn").textContent = "Save Item";
      photoDataPending = null;
    }

    function handleSave(e) {
      e.preventDefault();

      const dept = document.getElementById("department").value.trim();
      const location = document.getElementById("location").value.trim();
      const itemName = document.getElementById("item-name").value.trim();
      const itemNumber = document.getElementById("item-number").value.trim();
      const quantity = document.getElementById("quantity").value;
      const parLevel = document.getElementById("par-level").value;
      const expiration = document.getElementById("expiration").value;
      const notes = document.getElementById("notes").value.trim();

      if (!dept || !itemName || quantity === "" || parLevel === "") {
        alert("Department, Item, Qty on Hand, and PAR are required.");
        return;
      }

      const editId = document.getElementById("edit-index").value;
      const isEdit = editId !== "";

      const makeId = () => {
        if (window.crypto && window.crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      };

      const data = {
        id: isEdit ? editId : makeId(),
        department: dept,
        location,
        itemName,
        itemNumber,
        quantity: Number(quantity),
        parLevel: Number(parLevel),
        expiration: expiration || "",
        notes,
        photoData: photoDataPending ?? null,
        updatedAt: new Date().toISOString(),
      };

      if (isEdit) {
        const index = items.findIndex((i) => i.id === editId);
        if (index !== -1) {
          if (photoDataPending === null) {
            data.photoData = items[index].photoData;
          }
          items[index] = data;
        }
      } else {
        items.push(data);
      }

      saveItems();
      clearForm();
      renderTable();
    }

    function startEditItem(id) {
      const item = items.find((i) => i.id === id);
      if (!item) return;

      document.getElementById("edit-index").value = item.id;
      document.getElementById("department").value = item.department || "";
      document.getElementById("location").value = item.location || "";
      document.getElementById("item-name").value = item.itemName || "";
      document.getElementById("item-number").value = item.itemNumber || "";
      document.getElementById("quantity").value = item.quantity ?? "";
      document.getElementById("par-level").value = item.parLevel ?? "";
      document.getElementById("expiration").value = item.expiration || "";
      document.getElementById("notes").value = item.notes || "";

      photoDataPending = null;

      document.getElementById("form-title").textContent = "Edit Item";
      document.getElementById("save-btn").textContent = "Save Changes";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteItem(id) {
      if (!confirm("Delete this item?")) return;
      items = items.filter((i) => i.id !== id);
      saveItems();
      renderTable();
    }

    function resetAllData() {
      if (
        !confirm(
          "This will delete ALL overstock items stored in this browser (local only). Continue?"
        )
      )
        return;

      items = [];
      saveItems();
      renderTable();
      clearForm();
    }

    function handlePhotoInput(e) {
      const file = e.target.files[0];
      if (!file) {
        photoDataPending = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        photoDataPending = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function exportCSV() {
      if (!items.length) {
        alert("No items to export.");
        return;
      }

      const headers = [
        "Department",
        "Location",
        "Item",
        "ItemNumber",
        "Quantity",
        "ParLevel",
        "Status",
        "Expiration",
        "Notes",
        "UpdatedAt",
      ];

      const rows = items.map((item) => {
        const status = computeStatus(item).label;
        return [
          item.department || "",
          item.location || "",
          item.itemName || "",
          item.itemNumber || "",
          item.quantity ?? "",
          item.parLevel ?? "",
          status,
          item.expiration || "",
          (item.notes || "").replace(/\r?\n/g, " "),
          item.updatedAt || "",
        ];
      });

      const csvContent = [headers.join(","), ...rows.map((r) => r.join(","))]
        .join("\n")
        .replace(/\uFEFF/g, "");

      const blob = new Blob(["\uFEFF" + csvContent], {
        type: "text/csv;charset=utf-8;",
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "phc_overstock.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function openPhotoModal(dataUrl) {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = dataUrl;
      modal.style.display = "flex";
    }

    function closePhotoModal() {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = "";
      modal.style.display = "none";
    }

    /**********************
     * SYNC TO SERVER + AUTO-SYNC
     **********************/

    async function syncToServer() {
      const statusEl = document.getElementById("sync-status");
      statusEl.classList.remove("ok", "error");

      if (!API_ENDPOINT) {
        statusEl.textContent =
          "No API endpoint configured yet. Ask IT/BI to set API_ENDPOINT in the code.";
        statusEl.classList.add("error");
        return;
      }

      if (!items.length) {
        statusEl.textContent = "Nothing to sync (no items).";
        return;
      }

      if (isSyncInProgress) {
        return; // avoid overlapping syncs
      }

      isSyncInProgress = true;
      statusEl.textContent = "Syncing to server‚Ä¶";

      try {
        const payload = {
          source: "PHC_OVERSTOCK_WEBAPP",
          syncedAt: new Date().toISOString(),
          items,
        };

        const headers = { "Content-Type": "application/json" };

        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("Server responded with " + res.status);
        }

        const now = new Date().toLocaleString();
        localStorage.setItem(LAST_SYNC_KEY, now);
        document.getElementById("last-sync").textContent = now;
        statusEl.textContent = "Sync successful.";
        statusEl.classList.add("ok");
      } catch (err) {
        console.error("Sync failed:", err);
        statusEl.textContent =
          "Sync failed. Check your connection or ask IT to verify the API.";
        statusEl.classList.add("error");
      } finally {
        isSyncInProgress = false;
      }
    }

    /**********************
     * PWA: manifest + service worker
     **********************/

    const MANIFEST_JSON = JSON.stringify({
      name: "PHC Overstock Tracker",
      short_name: "Overstock",
      start_url: ".",
      display: "standalone",
      background_color: "#f0f2f7",
      theme_color: "#1b4f72",
      icons: []
    });

    const SW_CODE = `
      const CACHE_NAME = "phc-overstock-cache-v1";
      const URLS_TO_CACHE = ["./"];

      self.addEventListener("install", (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then((cache) => cache.addAll(URLS_TO_CACHE))
        );
      });

      self.addEventListener("fetch", (event) => {
        event.respondWith(
          caches.match(event.request).then((response) => {
            return response || fetch(event.request);
          })
        );
      });
    `;

    function registerManifestAndServiceWorker() {
      // Dynamic manifest (helps Android; iOS mostly ignores it)
      try {
        const blob = new Blob([MANIFEST_JSON], { type: "application/json" });
        const manifestUrl = URL.createObjectURL(blob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = manifestUrl;
        document.head.appendChild(link);
      } catch (e) {
        console.warn("Manifest creation failed:", e);
      }

      // Service worker (for PWA/offline + Add to Home Screen behavior)
      if ("serviceWorker" in navigator) {
        try {
          const swBlob = new Blob([SW_CODE], { type: "text/javascript" });
          const swUrl = URL.createObjectURL(swBlob);
          navigator.serviceWorker
            .register(swUrl)
            .catch((err) => console.error("SW registration failed:", err));
        } catch (e) {
          console.error("Service worker setup failed:", e);
        }
      }
    }

    /**********************
     * INIT
     **********************/

    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderTable();

      document
        .getElementById("item-form")
        .addEventListener("submit", handleSave);
      document
        .getElementById("clear-btn")
        .addEventListener("click", clearForm);
      document
        .getElementById("reset-all-btn")
        .addEventListener("click", resetAllData);
      document
        .getElementById("photo-input")
        .addEventListener("change", handlePhotoInput);
      document
        .getElementById("filter-dept")
        .addEventListener("change", renderTable);
      document
        .getElementById("search-text")
        .addEventListener("input", renderTable);
      document
        .getElementById("export-btn")
        .addEventListener("click", exportCSV);
      document
        .getElementById("export-btn-top")
        .addEventListener("click", exportCSV);
      document
        .getElementById("sync-btn")
        .addEventListener("click", syncToServer);

      const modal = document.getElementById("image-modal");
      modal.addEventListener("click", closePhotoModal);

      // Auto-sync every 5 minutes when online
      setInterval(() => {
        if (navigator.onLine) {
          syncToServer();
        }
      }, 5 * 60 * 1000);

      // PWA setup
      registerManifestAndServiceWorker();
    });
  </script>
</body>
</html>
