<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Providence Holy Cross – Overstock Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1b4f72" />

  <style>
    :root {
      --ok-bg: #e8f5e9;
      --ok-text: #2e7d32;
      --ok-border: #2e7d32;

      --low-bg: #fff8e1;
      --low-text: #ff6f00;
      --low-border: #ff6f00;

      --over-bg: #ffebee;
      --over-text: #b71c1c;
      --over-border: #b71c1c;

      --card-bg: #ffffff;
      --card-border: #dde2eb;
      --body-bg: #f0f2f7;
      --primary: #1b4f72;
      --primary-soft: #e3eef8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 16px 16px 32px;
      background: var(--body-bg);
      color: #222;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
      color: var(--primary);
      font-size: 1.4rem;
      letter-spacing: 0.04em;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
    }

    .top-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 12px 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      margin-bottom: 12px;
    }

    .top-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .app-title-small {
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #333;
    }

    .phc-tag {
      font-size: 0.75rem;
      color: #777;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }

    .filters select,
    .filters input {
      border-radius: 999px;
      border: 1px solid #c5cad5;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #fbfcff;
      flex: 1;
      min-width: 0;
    }

    .count-label {
      font-size: 0.75rem;
      color: #777;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      width: 100%;
    }

    .btn-secondary {
      background: #e0e3ec;
      color: #333;
    }

    .btn-ghost {
      background: transparent;
      color: #555;
      border: 1px solid #c5cad5;
    }

    .dual-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .dual-buttons button {
      flex: 1;
    }

    .sync-status {
      font-size: 0.72rem;
      margin-top: 4px;
      color: #555;
    }

    .sync-status.ok {
      color: #2e7d32;
    }

    .sync-status.error {
      color: #b71c1c;
    }

    .sync-meta {
      font-size: 0.7rem;
      color: #777;
    }

    /* Item list */
    .section-title {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #555;
      margin: 14px 0 6px;
    }

    .items-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .item-card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--card-border);
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .item-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .item-name {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .item-dept {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #666;
    }

    .item-sub {
      font-size: 0.8rem;
      color: #555;
    }

    .item-sub span {
      margin-right: 8px;
    }

    .item-sub-small {
      font-size: 0.74rem;
      color: #777;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 700;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .status-ok {
      background: var(--ok-bg);
      color: var(--ok-text);
      border-color: var(--ok-border);
    }

    .status-low {
      background: var(--low-bg);
      color: var(--low-text);
      border-color: var(--low-border);
    }

    .status-over {
      background: var(--over-bg);
      color: var(--over-text);
      border-color: var(--over-border);
    }

    .item-notes {
      font-size: 0.76rem;
      color: #555;
      margin-top: 2px;
    }

    .item-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 8px;
    }

    .item-actions {
      display: flex;
      gap: 4px;
    }

    .item-actions button {
      padding: 4px 8px;
      font-size: 0.72rem;
    }

    .photo-thumb {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .no-items {
      font-size: 0.8rem;
      color: #777;
      text-align: center;
      margin-top: 10px;
    }

    /* Form sheet */
    .form-sheet {
      margin-top: 16px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 12px 14px 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
    }

    .form-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .form-sheet-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--primary);
    }

    .form-sheet-hint {
      font-size: 0.72rem;
      color: #777;
      margin-bottom: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 6px;
      border: 1px solid #c5cad5;
      padding: 6px 8px;
      font-size: 0.85rem;
      font-family: inherit;
      background: #fbfcff;
    }

    .form-group textarea {
      min-height: 48px;
      resize: vertical;
    }

    .hint {
      font-size: 0.7rem;
      color: #777;
      margin-top: 2px;
    }

    /* Image modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop img {
      max-width: 96vw;
      max-height: 96vh;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    /* Power BI iframe */
    .pbi-frame {
      width: 100%;
      min-height: 220px;
      border: 0;
      border-radius: 12px;
      background: #000;
      margin-top: 8px;
    }

    @media (min-width: 900px) {
      body {
        padding-top: 24px;
      }
      .pbi-frame {
        min-height: 280px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <h1>OVERSTOCK TRACKER</h1>
    <div class="subtitle">Providence Holy Cross – Supply Chain</div>

    <!-- Top card: filters + sync -->
    <div class="top-card">
      <div class="top-row-header">
        <div>
          <div class="app-title-small">Live Floor View</div>
          <div class="phc-tag">Overstock by department</div>
        </div>
        <div class="count-label">
          Items: <span id="item-count">0</span>
        </div>
      </div>

      <div class="filters">
        <select id="filter-dept">
          <option value="">All Departments</option>
          <option>2 SOUTH</option>
          <option>2 EAST</option>
          <option>3 NORTH</option>
          <option>ICU</option>
          <option>ED</option>
          <option>OR</option>
          <option>Other</option>
        </select>
        <input
          type="text"
          id="search-text"
          placeholder="Search item, vendor #, notes..."
        />
      </div>

      <div class="dual-buttons">
        <button type="button" class="btn-primary" id="sync-btn">
          Sync to Server
        </button>
        <button type="button" class="btn-ghost" id="export-btn-top">
          Export CSV
        </button>
      </div>

      <div id="sync-status" class="sync-status">
        Not synced yet.
      </div>
      <div class="sync-meta">
        Last sync: <span id="last-sync">–</span>
      </div>
    </div>

    <!-- Item list -->
    <div class="section-title">Overstock</div>
    <div id="items-list" class="items-list"></div>
    <div id="no-items" class="no-items">No items logged yet.</div>

    <!-- Add item button (scrolls to form) -->
    <div style="margin-top: 10px;">
      <button type="button" class="btn-primary" onclick="scrollToForm()">
        + Add Item
      </button>
    </div>

    <!-- Power BI card -->
    <div class="section-title">Leadership Dashboard</div>
    <div class="top-card">
      <div class="phc-tag">
        IT / BI can embed a secure Power BI report here (not "publish to web").
      </div>
      <iframe
        id="pbi-report"
        class="pbi-frame"
        src=""
        title="Overstock Power BI Report"
      ></iframe>
      <div class="sync-meta">
        If this is blank, the Power BI embed URL has not been configured yet.
      </div>
    </div>

    <!-- Form sheet -->
    <div id="form-sheet" class="form-sheet">
      <div class="form-sheet-header">
        <div class="form-sheet-title" id="form-title">Add New Item</div>
        <button type="button" class="btn-ghost" id="reset-all-btn" style="padding:4px 10px;font-size:0.72rem;">
          Reset Local Data
        </button>
      </div>
      <div class="form-sheet-hint">
        Fill this out in the supply room. Data stays on this device until you sync.
      </div>

      <form id="item-form">
        <input type="hidden" id="edit-index" value="" />

        <div class="form-grid">
          <div class="form-group">
            <label for="department">Department</label>
            <select id="department" required>
              <option value="">Select...</option>
              <option>2 SOUTH</option>
              <option>2 EAST</option>
              <option>3 NORTH</option>
              <option>ICU</option>
              <option>ED</option>
              <option>OR</option>
              <option>Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="location">Supply Location (Room/Shelf)</label>
            <input
              type="text"
              id="location"
              placeholder="e.g., Core A – Shelf 2"
            />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="item-name">Item Description</label>
            <input
              type="text"
              id="item-name"
              placeholder="e.g., 4x4 Gauze, 18G IV Catheter"
              required
            />
          </div>

          <div class="form-group">
            <label for="item-number">Vendor / Item # / Barcode</label>
            <input
              type="text"
              id="item-number"
              placeholder="Scan or type number"
            />
            <div class="hint">
              You can type the number or scan using your phone's camera app.
            </div>
          </div>

          <div class="form-group">
            <label for="quantity">Qty on Hand</label>
            <input
              type="number"
              id="quantity"
              min="0"
              placeholder="e.g., 45"
              required
            />
          </div>

          <div class="form-group">
            <label for="par-level">Target / PAR Qty</label>
            <input
              type="number"
              id="par-level"
              min="0"
              placeholder="e.g., 20"
              required
            />
            <div class="hint">Used to calculate LOW vs OVERSTOCK.</div>
          </div>

          <div class="form-group">
            <label for="expiration">Expiration Date (optional)</label>
            <input type="date" id="expiration" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="notes">Notes (optional)</label>
            <textarea
              id="notes"
              placeholder="e.g., Move to 2 EAST first, box slightly damaged…"
            ></textarea>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="photo-input">Item Photo (optional)</label>
            <input
              type="file"
              id="photo-input"
              accept="image/*"
              capture="environment"
            />
            <div class="hint">
              On mobile this should open the back camera. Take a quick photo of
              the box, label, or shelf.
            </div>
          </div>
        </div>

        <div class="dual-buttons" style="margin-top:10px;">
          <button type="submit" class="btn-primary" id="save-btn">
            Save Item
          </button>
          <button type="button" class="btn-secondary" id="clear-btn">
            Clear Form
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image modal -->
  <div class="modal-backdrop" id="image-modal">
    <img id="modal-image" src="" alt="Item photo" />
  </div>

  <script>
    /**********************
     * CONFIG (IT to edit)
     **********************/

    const API_ENDPOINT = "";         // IT: your secure API URL
    const POWER_BI_EMBED_URL = "";  // IT: your Power BI embed URL

    /**********************
     * LOCAL APP LOGIC
     **********************/

    const STORAGE_KEY = "phc_overstock_items_v2";
    const LAST_SYNC_KEY = "phc_overstock_last_sync";

    let items = [];
    let photoDataPending = null;
    let isSyncInProgress = false;

    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        items = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error loading items:", e);
        items = [];
      }

      const last = localStorage.getItem(LAST_SYNC_KEY);
      if (last) {
        document.getElementById("last-sync").textContent = last;
        const statusEl = document.getElementById("sync-status");
        statusEl.textContent = "Last sync succeeded.";
        statusEl.classList.add("ok");
      }

      if (POWER_BI_EMBED_URL) {
        const iframe = document.getElementById("pbi-report");
        iframe.src = POWER_BI_EMBED_URL;
      }
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function computeStatus(item) {
      const qty = Number(item.quantity || 0);
      const par = Number(item.parLevel || 0);

      if (!par && !qty) return { label: "OK", className: "status-ok" };
      if (par === 0) return { label: "OK", className: "status-ok" };

      if (qty < par) return { label: "LOW", className: "status-low" };
      if (qty > par) return { label: "OVERSTOCK", className: "status-over" };

      return { label: "OK", className: "status-ok" };
    }

    function applyFilters(baseItems) {
      const deptFilter = document.getElementById("filter-dept").value.trim();
      const searchText = document
        .getElementById("search-text")
        .value.trim()
        .toLowerCase();

      return baseItems.filter((item) => {
        if (deptFilter && item.department !== deptFilter) return false;

        if (searchText) {
          const blob = (
            (item.department || "") +
            " " +
            (item.itemName || "") +
            " " +
            (item.itemNumber || "") +
            " " +
            (item.notes || "") +
            " " +
            (item.location || "")
          )
            .toLowerCase()
            .includes(searchText);

          if (!blob) return false;
        }

        return true;
      });
    }

    function renderList() {
      const listEl = document.getElementById("items-list");
      const emptyEl = document.getElementById("no-items");
      listEl.innerHTML = "";

      const filtered = applyFilters(items);
      document.getElementById("item-count").textContent = filtered.length;

      if (filtered.length === 0) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      filtered.forEach((item) => {
        const { label, className } = computeStatus(item);

        const card = document.createElement("div");
        card.className = "item-card";

        const topRow = document.createElement("div");
        topRow.className = "item-top-row";

        const leftInfo = document.createElement("div");
        const nameEl = document.createElement("div");
        nameEl.className = "item-name";
        nameEl.textContent = item.itemName || "";

        const deptEl = document.createElement("div");
        deptEl.className = "item-dept";
        deptEl.textContent = (item.department || "").toUpperCase();

        leftInfo.appendChild(nameEl);
        leftInfo.appendChild(deptEl);

        const statusEl = document.createElement("span");
        statusEl.className = "status-pill " + className;
        statusEl.textContent = label;

        topRow.appendChild(leftInfo);
        topRow.appendChild(statusEl);

        const middleRow = document.createElement("div");
        middleRow.className = "item-sub";
        middleRow.innerHTML = `
          <span>Qty: <strong>${item.quantity ?? ""}</strong></span>
          <span>PAR: <strong>${item.parLevel ?? ""}</strong></span>
        `;

        const subSmall = document.createElement("div");
        subSmall.className = "item-sub-small";
        const parts = [];
        if (item.itemNumber) parts.push("Item #: " + item.itemNumber);
        if (item.location) parts.push("Location: " + item.location);
        if (item.expiration) parts.push("Exp: " + item.expiration);
        subSmall.textContent = parts.join(" • ");

        const notesEl = document.createElement("div");
        notesEl.className = "item-notes";
        notesEl.textContent = item.notes || "";

        const footerRow = document.createElement("div");
        footerRow.className = "item-footer-row";

        const leftFooter = document.createElement("div");
        if (item.photoData) {
          const img = document.createElement("img");
          img.src = item.photoData;
          img.className = "photo-thumb";
          img.title = "Tap to enlarge";
          img.addEventListener("click", () => openPhotoModal(item.photoData));
          leftFooter.appendChild(img);
        }

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-secondary";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => startEditItem(item.id));

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-ghost";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => deleteItem(item.id));

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        footerRow.appendChild(leftFooter);
        footerRow.appendChild(actions);

        card.appendChild(topRow);
        card.appendChild(middleRow);
        if (parts.length) card.appendChild(subSmall);
        if (item.notes) card.appendChild(notesEl);
        card.appendChild(footerRow);

        listEl.appendChild(card);
      });
    }

    function clearForm() {
      document.getElementById("item-form").reset();
      document.getElementById("edit-index").value = "";
      document.getElementById("form-title").textContent = "Add New Item";
      document.getElementById("save-btn").textContent = "Save Item";
      photoDataPending = null;
    }

    function handleSave(e) {
      e.preventDefault();

      const dept = document.getElementById("department").value.trim();
      const location = document.getElementById("location").value.trim();
      const itemName = document.getElementById("item-name").value.trim();
      const itemNumber = document.getElementById("item-number").value.trim();
      const quantity = document.getElementById("quantity").value;
      const parLevel = document.getElementById("par-level").value;
      const expiration = document.getElementById("expiration").value;
      const notes = document.getElementById("notes").value.trim();

      if (!dept || !itemName || quantity === "" || parLevel === "") {
        alert("Department, Item, Qty on Hand, and PAR are required.");
        return;
      }

      const editId = document.getElementById("edit-index").value;
      const isEdit = editId !== "";

      const makeId = () => {
        if (window.crypto && window.crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      };

      const data = {
        id: isEdit ? editId : makeId(),
        department: dept,
        location,
        itemName,
        itemNumber,
        quantity: Number(quantity),
        parLevel: Number(parLevel),
        expiration: expiration || "",
        notes,
        photoData: photoDataPending ?? null,
        updatedAt: new Date().toISOString(),
      };

      if (isEdit) {
        const index = items.findIndex((i) => i.id === editId);
        if (index !== -1) {
          if (photoDataPending === null) {
            data.photoData = items[index].photoData;
          }
          items[index] = data;
        }
      } else {
        items.push(data);
      }

      saveItems();
      clearForm();
      renderList();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function startEditItem(id) {
      const item = items.find((i) => i.id === id);
      if (!item) return;

      document.getElementById("edit-index").value = item.id;
      document.getElementById("department").value = item.department || "";
      document.getElementById("location").value = item.location || "";
      document.getElementById("item-name").value = item.itemName || "";
      document.getElementById("item-number").value = item.itemNumber || "";
      document.getElementById("quantity").value = item.quantity ?? "";
      document.getElementById("par-level").value = item.parLevel ?? "";
      document.getElementById("expiration").value = item.expiration || "";
      document.getElementById("notes").value = item.notes || "";

      photoDataPending = null;

      document.getElementById("form-title").textContent = "Edit Item";
      document.getElementById("save-btn").textContent = "Save Changes";
      scrollToForm();
    }

    function deleteItem(id) {
      if (!confirm("Delete this item?")) return;
      items = items.filter((i) => i.id !== id);
      saveItems();
      renderList();
    }

    function resetAllData() {
      if (
        !confirm(
          "This will delete ALL overstock items stored in this browser (local only). Continue?"
        )
      )
        return;

      items = [];
      saveItems();
      renderList();
      clearForm();
    }

    function handlePhotoInput(e) {
      const file = e.target.files[0];
      if (!file) {
        photoDataPending = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        photoDataPending = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function exportCSV() {
      if (!items.length) {
        alert("No items to export.");
        return;
      }

      const headers = [
        "Department",
        "Location",
        "Item",
        "ItemNumber",
        "Quantity",
        "ParLevel",
        "Status",
        "Expiration",
        "Notes",
        "UpdatedAt",
      ];

      const rows = items.map((item) => {
        const status = computeStatus(item).label;
        return [
          item.department || "",
          item.location || "",
          item.itemName || "",
          item.itemNumber || "",
          item.quantity ?? "",
          item.parLevel ?? "",
          status,
          item.expiration || "",
          (item.notes || "").replace(/\r?\n/g, " "),
          item.updatedAt || "",
        ];
      });

      const csvContent = [headers.join(","), ...rows.map((r) => r.join(","))]
        .join("\n")
        .replace(/\uFEFF/g, "");

      const blob = new Blob(["\uFEFF" + csvContent], {
        type: "text/csv;charset=utf-8;",
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "phc_overstock.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function openPhotoModal(dataUrl) {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = dataUrl;
      modal.style.display = "flex";
    }

    function closePhotoModal() {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = "";
      modal.style.display = "none";
    }

    function scrollToForm() {
      const formSheet = document.getElementById("form-sheet");
      const rect = formSheet.getBoundingClientRect();
      const offset = rect.top + window.scrollY - 10;
      window.scrollTo({ top: offset, behavior: "smooth" });
    }

    /**********************
     * SYNC TO SERVER + AUTO-SYNC
     **********************/

    async function syncToServer() {
      const statusEl = document.getElementById("sync-status");
      statusEl.classList.remove("ok", "error");

      if (!API_ENDPOINT) {
        statusEl.textContent =
          "No API endpoint configured yet. Ask IT/BI to set API_ENDPOINT in the code.";
        statusEl.classList.add("error");
        return;
      }

      if (!items.length) {
        statusEl.textContent = "Nothing to sync (no items).";
        return;
      }

      if (isSyncInProgress) {
        return;
      }

      isSyncInProgress = true;
      statusEl.textContent = "Syncing to server…";

      try {
        const payload = {
          source: "PHC_OVERSTOCK_WEBAPP",
          syncedAt: new Date().toISOString(),
          items,
        };

        const headers = { "Content-Type": "application/json" };

        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("Server responded with " + res.status);
        }

        const now = new Date().toLocaleString();
        localStorage.setItem(LAST_SYNC_KEY, now);
        document.getElementById("last-sync").textContent = now;
        statusEl.textContent = "Sync successful.";
        statusEl.classList.add("ok");
      } catch (err) {
        console.error("Sync failed:", err);
        statusEl.textContent =
          "Sync failed. Check your connection or ask IT to verify the API.";
        statusEl.classList.add("error");
      } finally {
        isSyncInProgress = false;
      }
    }

    /**********************
     * PWA: manifest + service worker
     **********************/

    const MANIFEST_JSON = JSON.stringify({
      name: "PHC Overstock Tracker",
      short_name: "Overstock",
      start_url: ".",
      display: "standalone",
      background_color: "#f0f2f7",
      theme_color: "#1b4f72",
      icons: []
    });

    const SW_CODE = `
      const CACHE_NAME = "phc-overstock-cache-v1";
      const URLS_TO_CACHE = ["./"];

      self.addEventListener("install", (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then((cache) => cache.addAll(URLS_TO_CACHE))
        );
      });

      self.addEventListener("fetch", (event) => {
        event.respondWith(
          caches.match(event.request).then((response) => {
            return response || fetch(event.request);
          })
        );
      });
    `;

    function registerManifestAndServiceWorker() {
      try {
        const blob = new Blob([MANIFEST_JSON], { type: "application/json" });
        const manifestUrl = URL.createObjectURL(blob);
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = manifestUrl;
        document.head.appendChild(link);
      } catch (e) {
        console.warn("Manifest creation failed:", e);
      }

      if ("serviceWorker" in navigator) {
        try {
          const swBlob = new Blob([SW_CODE], { type: "text/javascript" });
          const swUrl = URL.createObjectURL(swBlob);
          navigator.serviceWorker
            .register(swUrl)
            .catch((err) => console.error("SW registration failed:", err));
        } catch (e) {
          console.error("Service worker setup failed:", e);
        }
      }
    }

    /**********************
     * INIT
     **********************/

    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderList();

      document
        .getElementById("item-form")
        .addEventListener("submit", handleSave);
      document
        .getElementById("clear-btn")
        .addEventListener("click", clearForm);
      document
        .getElementById("reset-all-btn")
        .addEventListener("click", resetAllData);
      document
        .getElementById("photo-input")
        .addEventListener("change", handlePhotoInput);
      document
        .getElementById("filter-dept")
        .addEventListener("change", renderList);
      document
        .getElementById("search-text")
        .addEventListener("input", renderList);
      document
        .getElementById("export-btn-top")
        .addEventListener("click", exportCSV);
      document
        .getElementById("sync-btn")
        .addEventListener("click", syncToServer);

      const modal = document.getElementById("image-modal");
      modal.addEventListener("click", closePhotoModal);

      // Auto-sync every 5 minutes when online
      setInterval(() => {
        if (navigator.onLine) {
          syncToServer();
        }
      }, 5 * 60 * 1000);

      registerManifestAndServiceWorker();
    });
  </script>
</body>
</html>
