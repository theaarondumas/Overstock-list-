<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Providence Holy Cross – Backorder & Stock Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="referrer" content="no-referrer" />

  <!-- Power BI JavaScript client (for embedding) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.23.0/powerbi.min.js"></script>

  <style>
    :root {
      --ok-bg: #e8f5e9;
      --ok-text: #2e7d32;
      --ok-border: #2e7d32;

      --low-bg: #fff8e1;
      --low-text: #ff6f00;
      --low-border: #ff6f00;

      --bo-bg: #ffebee;
      --bo-text: #b71c1c;
      --bo-border: #b71c1c;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      line-height: 1.5;
      font-size: 16px;
      background: #f7f7f7;
    }

    /* Branding header */
    .brand-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: #0053a0;
      position: relative;
    }

    .brand-mark::before,
    .brand-mark::after {
      content: "";
      position: absolute;
      background: #ffffff;
    }

    .brand-mark::before {
      width: 60%;
      height: 20%;
      top: 40%;
      left: 20%;
    }

    .brand-mark::after {
      width: 20%;
      height: 60%;
      top: 20%;
      left: 40%;
    }

    .brand-text-main {
      font-weight: bold;
      font-size: 1.1rem;
      color: #003366;
    }

    .brand-text-sub {
      font-size: 0.9rem;
      color: #555;
    }

    h1 {
      margin: 8px 0 4px;
      font-size: 1.6rem;
    }

    p {
      margin-top: 0;
      color: #555;
      font-size: 0.95rem;
    }

    .top-actions {
      margin: 12px 0 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .top-actions button {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: 1px solid #888;
      background: #ffffff;
      cursor: pointer;
    }

    .top-actions button:hover {
      background: #f0f0f0;
    }

    .hint {
      font-size: 0.8rem;
      color: #666;
    }

    /* Status summary chips */
    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 12px;
    }

    .summary-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .summary-chip.bo {
      background: var(--bo-bg);
      color: var(--bo-text);
      border-color: var(--bo-border);
    }
    .summary-chip.low {
      background: var(--low-bg);
      color: var(--low-text);
      border-color: var(--low-border);
    }
    .summary-chip.ok {
      background: var(--ok-bg);
      color: var(--ok-text);
      border-color: var(--ok-border);
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      min-width: 1100px;
      background: #ffffff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.85rem;
      vertical-align: top;
    }

    th {
      background-color: #f2f2f2;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Make key columns wider */
    th:nth-child(1), td:nth-child(1) { min-width: 220px; } /* Item */
    th:nth-child(2), td:nth-child(2) { min-width: 120px; } /* Dept */
    th:nth-child(3), td:nth-child(3) { min-width: 140px; } /* Vendor/No */
    th:nth-child(4), td:nth-child(4) { min-width: 140px; } /* Photo */

    tr:nth-child(even) {
      background-color: #fcfcfc;
    }

    /* Row status highlighting */
    .row-ok {
      background-color: #f9fff9;
    }
    .row-low {
      background-color: #fffaf0;
    }
    .row-bo {
      background-color: #fff7f7;
    }

    .status-pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
      white-space: nowrap;
    }
    .pill-ok {
      background: var(--ok-bg);
      color: var(--ok-text);
      border: 1px solid var(--ok-border);
    }
    .pill-low {
      background: var(--low-bg);
      color: var(--low-text);
      border: 1px solid var(--low-border);
    }
    .pill-bo {
      background: var(--bo-bg);
      color: var(--bo-text);
      border: 1px solid var(--bo-border);
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      font-size: 0.8rem;
      padding: 3px 4px;
      width: 100%;
      box-sizing: border-box;
    }

    input[type="number"] {
      text-align: right;
    }

    textarea {
      resize: vertical;
      min-height: 28px;
      max-height: 80px;
    }

    .delete-btn {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #b71c1c;
      background: #ffebee;
      color: #b71c1c;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: #ffcdd2;
    }

    .photo-thumb {
      max-width: 60px;
      max-height: 60px;
      border-radius: 4px;
      display: block;
      margin-bottom: 4px;
      object-fit: cover;
    }

    .photo-hint {
      font-size: 0.7rem;
      color: #777;
      margin-bottom: 4px;
    }

    .photo-btn,
    .scan-btn {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #f7f7f7;
      cursor: pointer;
      margin-top: 4px;
      display: inline-block;
    }

    .photo-btn:hover,
    .scan-btn:hover {
      background: #e4e4e4;
    }

    /* Scanner overlay */
    .scanner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .scanner-box {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    .scanner-title {
      font-weight: bold;
      margin-bottom: 6px;
    }

    #scannerVideo {
      width: 100%;
      border-radius: 8px;
      background: #000;
    }

    .scanner-hint {
      font-size: 0.75rem;
      color: #555;
      margin: 6px 0;
    }

    .scanner-cancel-btn {
      margin-top: 4px;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #555;
      background: #f0f0f0;
      cursor: pointer;
    }

    .scanner-cancel-btn:hover {
      background: #e0e0e0;
    }

    /* Power BI panel */
    .powerbi-panel {
      margin-top: 20px;
      padding-top: 10px;
    }

    .powerbi-header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .powerbi-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    #powerbiContainer {
      margin-top: 10px;
      min-height: 360px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
      background: #111827;
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
        font-size: 15px;
      }

      h1 {
        font-size: 1.3rem;
      }

      th, td {
        font-size: 0.8rem;
        padding: 6px;
      }
    }
  </style>
</head>

<body>
  <div class="brand-header">
    <div class="brand-mark"></div>
    <div>
      <div class="brand-text-main">Providence Holy Cross Medical Center</div>
      <div class="brand-text-sub">Backordered & Low Stock Supply Dashboard</div>
    </div>
  </div>

  <h1>Backorder & Stock Dashboard</h1>
  <p>
    Track backordered, low stock, and available supplies.<br>
    Status is based on <strong>On Hand vs Par Level</strong> and vendor status.<br>
    You can attach a <strong>photo</strong> of each item and scan the <strong>barcode</strong>
    to auto-fill Vendor / Item #. Power BI can then use this data for live analytics.
  </p>

  <div class="top-actions">
    <button id="addItemButton" type="button">Add new blank item</button>
    <button id="resetButton" type="button">Reset to sample list</button>
    <button id="syncAllPowerBIButton" type="button">Sync all items to Power BI</button>
    <button id="openReportButton" type="button">Open Power BI report</button>
    <span class="hint">
      (Data & photos are saved locally in this browser using localStorage. Do not enter patient information.)
    </span>
  </div>

  <div class="summary-row">
    <div class="summary-chip bo">Backordered / Out: <span id="countBo">0</span></div>
    <div class="summary-chip low">Low stock: <span id="countLow">0</span></div>
    <div class="summary-chip ok">OK / Available: <span id="countOk">0</span></div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Item Name</th>
          <th>Dept / Unit</th>
          <th>Vendor / Item #</th>
          <th>Photo</th>
          <th>On Hand</th>
          <th>Par Level</th>
          <th>On Order</th>
          <th>Vendor Status</th>
          <th>System Status</th>
          <th>Notes</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
    </table>
  </div>

  <!-- Power BI analytics panel -->
  <div class="powerbi-panel">
    <div class="powerbi-header">
      <h2>Power BI Backorder Analytics</h2>
      <span class="hint">
        This embedded view should be connected to the same dataset your dashboard sends to.
      </span>
    </div>
    <div id="powerbiContainer"></div>
  </div>

  <!-- Barcode scanner overlay -->
  <div id="scannerOverlay" class="scanner-overlay" style="display:none;">
    <div class="scanner-box">
      <div class="scanner-title">Scan barcode</div>
      <video id="scannerVideo" autoplay playsinline></video>
      <div class="scanner-hint">
        Point the camera at the barcode on the box / label.<br>
        When it reads it, the Vendor / Item # field will auto-fill.
      </div>
      <button type="button" id="scannerCancelBtn" class="scanner-cancel-btn">
        Cancel
      </button>
    </div>
  </div>

  <!-- ZXing barcode library -->
  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>

  <script>
    // =========================
    // 1 — CONFIG & DEFAULT DATA
    // =========================
    const STORAGE_KEY = "phcm_backorder_dashboard_v3";

    // ===== Power BI CONFIG =====
    // 1) STREAMING / PUSH DATASET URL (from Power BI)
    //    Looks like:
    //    https://api.powerbi.com/beta/.../datasets/.../rows?key=YOUR_KEY
    const POWER_BI_PUSH_URL =
      "https://api.powerbi.com/beta/YOUR_TENANT_ID/YOUR_WORKSPACE_ID/datasets/YOUR_DATASET_ID/rows?key=YOUR_PUSH_KEY";

    // 2) Full report URL in the Power BI Service (for the "Open report" button)
    const POWER_BI_FULL_REPORT_URL =
      "https://app.powerbi.com/groups/YOUR_WORKSPACE_ID/reports/YOUR_REPORT_ID/ReportSection";

    // 3) Embed config (ONLY if you are using embed tokens from a backend).
    //    For now this is a placeholder. Once your backend returns real values,
    //    you can fill these in and call embedPowerBIReport().
    const POWER_BI_EMBED_CONFIG = {
      type: "report",
      id: "YOUR_REPORT_ID",
      embedUrl: "https://app.powerbi.com/reportEmbed?reportId=YOUR_REPORT_ID&groupId=YOUR_WORKSPACE_ID",
      accessToken: "YOUR_EMBED_TOKEN", // get from your backend
      tokenType: window["powerbi-client"]
        ? window["powerbi-client"].models.TokenType.Embed
        : null,
      settings: {
        panes: {
          filters: { visible: false },
          pageNavigation: { visible: true }
        }
      }
    };

    const defaultItems = [
      {
        id: "i1",
        name: "Nitrile Exam Gloves Medium",
        dept: "2 SOUTH",
        vendor_item: "Medline MDS2501",
        on_hand: 3,
        par_level: 10,
        on_order: 5,
        vendor_status: "Backordered",
        notes: "Using alternate brand where available.",
        photoData: ""
      },
      {
        id: "i2",
        name: "IV Start Kit",
        dept: "3 EAST",
        vendor_item: "Cardinal IVK-100",
        on_hand: 15,
        par_level: 30,
        on_order: 0,
        vendor_status: "Normal",
        notes: "",
        photoData: ""
      },
      {
        id: "i3",
        name: "10 mL Saline Flush",
        dept: "ED",
        vendor_item: "BD 306559",
        on_hand: 120,
        par_level: 100,
        on_order: 200,
        vendor_status: "Normal",
        notes: "",
        photoData: ""
      },
      {
        id: "i4",
        name: "Suction Canister 1200 mL",
        dept: "ICU",
        vendor_item: "Medline DYND50265",
        on_hand: 0,
        par_level: 20,
        on_order: 40,
        vendor_status: "Backordered",
        notes: "Priority for next truck.",
        photoData: ""
      }
    ];

    let items = [];
    let nextId = 1000;

    // Barcode scanning state
    let currentScanItemId = null;
    let codeReader = null;

    // =========================
    // 2 — HELPERS
    // =========================
    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          items = JSON.parse(raw);
        } else {
          items = defaultItems.map(x => ({ ...x }));
        }
        items.forEach(it => {
          if (!("photoData" in it)) it.photoData = "";
        });
      } catch (e) {
        console.warn("Error loading items:", e);
        items = defaultItems.map(x => ({ ...x }));
      }

      nextId =
        items.reduce((max, it) => {
          const num = parseInt(String(it.id).replace(/\D/g, ""), 10);
          return isNaN(num) ? max : Math.max(max, num);
        }, 1000) + 1;
    }

    function saveItems() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      } catch (e) {
        console.warn("Error saving items:", e);
      }
    }

    function resetItems() {
      if (!confirm("Reset to sample list? This will erase current entries on this device.")) return;
      items = defaultItems.map(x => ({ ...x }));
      saveItems();
      renderTable();

      // Optional: also sync the sample set to Power BI
      // syncAllItemsToPowerBI();
    }

    function computeStatus(item) {
      const onHand = Number(item.on_hand) || 0;
      const par = Number(item.par_level) || 0;
      const vendor = (item.vendor_status || "").toLowerCase();

      if (vendor === "backordered" || vendor === "out" || onHand <= 0) {
        return "bo";
      }
      if (par > 0 && onHand < par) {
        return "low";
      }
      return "ok";
    }

    // =========================
    // 3 — POWER BI INTEGRATION
    // =========================
    function powerBIConfiguredForPush() {
      return (
        POWER_BI_PUSH_URL &&
        !POWER_BI_PUSH_URL.includes("YOUR_TENANT_ID") &&
        !POWER_BI_PUSH_URL.includes("YOUR_DATASET_ID") &&
        !POWER_BI_PUSH_URL.includes("YOUR_PUSH_KEY")
      );
    }

    async function pushItemToPowerBI(item) {
      if (!powerBIConfiguredForPush()) {
        // Silent no-op until you configure real URL
        return;
      }

      const statusCode = computeStatus(item);
      const systemStatus =
        statusCode === "bo"
          ? "Backordered / Out"
          : statusCode === "low"
          ? "Low stock"
          : "OK";

      // Define one row for your streaming/push dataset.
      // Make sure your Power BI dataset has matching columns.
      const row = {
        ItemName: item.name || "",
        Department: item.dept || "",
        VendorItem: item.vendor_item || "",
        OnHand: Number(item.on_hand) || 0,
        ParLevel: Number(item.par_level) || 0,
        OnOrder: Number(item.on_order) || 0,
        VendorStatus: item.vendor_status || "",
        SystemStatus: systemStatus,
        Notes: item.notes || "",
        // Good for trending/time series
        Timestamp: new Date().toISOString()
      };

      try {
        const res = await fetch(POWER_BI_PUSH_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify([row])
        });

        if (!res.ok) {
          console.error("Failed to push to Power BI:", await res.text());
        }
      } catch (err) {
        console.error("Error pushing to Power BI:", err);
      }
    }

    async function syncAllItemsToPowerBI() {
      if (!powerBIConfiguredForPush()) {
        alert("Configure POWER_BI_PUSH_URL in the script before syncing to Power BI.");
        return;
      }
      if (!items.length) {
        alert("No items to sync.");
        return;
      }

      // Simple approach: send all current items as one batch.
      const payload = items.map(item => {
        const statusCode = computeStatus(item);
        const systemStatus =
          statusCode === "bo"
            ? "Backordered / Out"
            : statusCode === "low"
            ? "Low stock"
            : "OK";
        return {
          ItemName: item.name || "",
          Department: item.dept || "",
          VendorItem: item.vendor_item || "",
          OnHand: Number(item.on_hand) || 0,
          ParLevel: Number(item.par_level) || 0,
          OnOrder: Number(item.on_order) || 0,
          VendorStatus: item.vendor_status || "",
          SystemStatus: systemStatus,
          Notes: item.notes || "",
          Timestamp: new Date().toISOString()
        };
      });

      try {
        const res = await fetch(POWER_BI_PUSH_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          console.error("Failed to sync all to Power BI:", await res.text());
          alert("Sync to Power BI failed. Check console for details.");
        } else {
          alert("All items synced to Power BI dataset.");
        }
      } catch (err) {
        console.error("Error syncing to Power BI:", err);
        alert("Sync to Power BI error. Check console for details.");
      }
    }

    function openPowerBIReport() {
      if (
        !POWER_BI_FULL_REPORT_URL ||
        POWER_BI_FULL_REPORT_URL.includes("YOUR_WORKSPACE_ID") ||
        POWER_BI_FULL_REPORT_URL.includes("YOUR_REPORT_ID")
      ) {
        alert("Set POWER_BI_FULL_REPORT_URL in the script to open your Power BI report.");
        return;
      }
      window.open(POWER_BI_FULL_REPORT_URL, "_blank");
    }

    function embedPowerBIReport() {
      if (!window["powerbi-client"]) {
        console.warn("powerbi-client not loaded.");
        return;
      }
      if (
        !POWER_BI_EMBED_CONFIG ||
        !POWER_BI_EMBED_CONFIG.accessToken ||
        POWER_BI_EMBED_CONFIG.accessToken === "YOUR_EMBED_TOKEN"
      ) {
        console.warn("Power BI embed config not set yet.");
        return;
      }

      const powerbiContainer = document.getElementById("powerbiContainer");
      const powerbi = new window["powerbi-client"].service.Service(
        window["powerbi-client"].factories.hpmFactory,
        window["powerbi-client"].factories.wpmpFactory,
        window["powerbi-client"].factories.routerFactory
      );

      powerbi.reset(powerbiContainer);
      powerbi.embed(powerbiContainer, POWER_BI_EMBED_CONFIG);
    }

    // =========================
    // 4 — BARCODE SCANNING
    // =========================
    async function startScanForItem(itemId) {
      currentScanItemId = itemId;
      const overlay = document.getElementById("scannerOverlay");
      const video = document.getElementById("scannerVideo");
      overlay.style.display = "flex";

      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }

      try {
        const devices = await codeReader.listVideoInputDevices();

        // Try to pick a back-facing / environment camera
        let backCam = devices.find(d =>
          (d.label || "").toLowerCase().includes("back") ||
          (d.label || "").toLowerCase().includes("environment")
        );

        if (!backCam && devices.length > 1) {
          // Fallback: last camera is often the rear one
          backCam = devices[devices.length - 1];
        }

        const chosenDeviceId = (backCam ? backCam.deviceId : devices[0]?.deviceId);

        await codeReader.decodeFromVideoDevice(chosenDeviceId, video, (result, err) => {
          if (result) {
            handleScanResult(result.getText());
          }
        });
      } catch (err) {
        console.error(err);
        alert("Unable to start camera / scanner. Check camera permissions on this device.");
        stopScan();
      }
    }

    function handleScanResult(text) {
      if (!currentScanItemId) return;
      const idx = items.findIndex(it => String(it.id) === String(currentScanItemId));
      if (idx === -1) return;
      items[idx].vendor_item = text;
      saveItems();
      stopScan();
      renderTable();

      // Push updated row to Power BI
      pushItemToPowerBI(items[idx]);
    }

    function stopScan() {
      if (codeReader) {
        try { codeReader.reset(); } catch (e) {}
      }
      const overlay = document.getElementById("scannerOverlay");
      overlay.style.display = "none";
      currentScanItemId = null;
    }

    // =========================
    // 5 — RENDER
    // =========================
    function renderTable() {
      const tbody = document.getElementById("itemsBody");
      tbody.innerHTML = "";

      let countBo = 0, countLow = 0, countOk = 0;

      items.forEach(item => {
        const status = computeStatus(item);
        if (status === "bo") countBo++;
        else if (status === "low") countLow++;
        else countOk++;

        const tr = document.createElement("tr");
        tr.className =
          status === "bo" ? "row-bo" :
          status === "low" ? "row-low" :
          "row-ok";

        const statusLabel =
          status === "bo" ? "Backordered / Out" :
          status === "low" ? "Low stock" :
          "OK";

        const pillClass =
          status === "bo" ? "pill-bo" :
          status === "low" ? "pill-low" :
          "pill-ok";

        tr.innerHTML = `
          <td>
            <input type="text" data-id="${item.id}" data-field="name" value="${item.name || ""}">
          </td>
          <td>
            <input type="text" data-id="${item.id}" data-field="dept" value="${item.dept || ""}">
          </td>
          <td>
            <input type="text" data-id="${item.id}" data-field="vendor_item" value="${item.vendor_item || ""}">
            <button type="button" class="scan-btn" data-id="${item.id}">Scan barcode</button>
          </td>
          <td>
            ${item.photoData
              ? `<img src="${item.photoData}" alt="Item photo" class="photo-thumb">`
              : `<div class="photo-hint">No photo yet</div>`
            }
            <button type="button" class="photo-btn" data-id="${item.id}">Add / Change photo</button>
            <input type="file" accept="image/*" capture="environment"
                   data-id="${item.id}" class="photo-input" style="display:none;">
          </td>
          <td>
            <input type="number" min="0" data-id="${item.id}" data-field="on_hand" value="${item.on_hand ?? ""}">
          </td>
          <td>
            <input type="number" min="0" data-id="${item.id}" data-field="par_level" value="${item.par_level ?? ""}">
          </td>
          <td>
            <input type="number" min="0" data-id="${item.id}" data-field="on_order" value="${item.on_order ?? ""}">
          </td>
          <td>
            <select data-id="${item.id}" data-field="vendor_status">
              <option value="Normal" ${item.vendor_status === "Normal" ? "selected" : ""}>Normal</option>
              <option value="Backordered" ${item.vendor_status === "Backordered" ? "selected" : ""}>Backordered</option>
              <option value="Out" ${item.vendor_status === "Out" ? "selected" : ""}>Out</option>
            </select>
          </td>
          <td>
            <span class="status-pill ${pillClass}">${statusLabel}</span>
          </td>
          <td>
            <textarea data-id="${item.id}" data-field="notes">${item.notes || ""}</textarea>
          </td>
          <td>
            <button type="button" class="delete-btn" data-action="delete" data-id="${item.id}">X</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      document.getElementById("countBo").textContent = countBo;
      document.getElementById("countLow").textContent = countLow;
      document.getElementById("countOk").textContent = countOk;

      attachListeners();
    }

    // =========================
    // 6 — LISTENERS
    // =========================
    function attachListeners() {
      const tbody = document.getElementById("itemsBody");

      // Text + textarea
      tbody.querySelectorAll("input[type='text'][data-id], textarea[data-id]").forEach(el => {
        el.addEventListener("input", () => {
          const id = el.getAttribute("data-id");
          const field = el.getAttribute("data-field");
          const idx = items.findIndex(it => String(it.id) === String(id));
          if (idx === -1) return;
          items[idx][field] = el.value;
          saveItems();

          // Push updated row to Power BI
          pushItemToPowerBI(items[idx]);
        });
      });

      // Numbers + vendor status
      tbody.querySelectorAll("input[type='number'][data-id], select[data-id]").forEach(el => {
        el.addEventListener("change", () => {
          const id = el.getAttribute("data-id");
          const field = el.getAttribute("data-field");
          const idx = items.findIndex(it => String(it.id) === String(id));
          if (idx === -1) return;
          if (el.type === "number") {
            items[idx][field] = el.value === "" ? "" : Number(el.value);
          } else {
            items[idx][field] = el.value;
          }
          saveItems();
          renderTable();

          // Push updated row to Power BI
          pushItemToPowerBI(items[idx]);
        });
      });

      // Photo buttons
      tbody.querySelectorAll(".photo-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const input = tbody.querySelector(`.photo-input[data-id="${id}"]`);
          if (input) input.click();
        });
      });

      // Photo input -> FileReader
      tbody.querySelectorAll(".photo-input").forEach(input => {
        input.addEventListener("change", () => {
          const file = input.files && input.files[0];
          if (!file) return;

          const id = input.getAttribute("data-id");
          const idx = items.findIndex(it => String(it.id) === String(id));
          if (idx === -1) return;

          const reader = new FileReader();
          reader.onload = function(e) {
            items[idx].photoData = e.target.result;
            saveItems();
            renderTable();

            // Optional: you could push to Power BI, but photos usually stay local.
          };
          reader.readAsDataURL(file);
        });
      });

      // Scan barcode buttons
      tbody.querySelectorAll(".scan-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          startScanForItem(id);
        });
      });

      // Delete buttons
      tbody.querySelectorAll("button[data-action='delete']").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          items = items.filter(it => String(it.id) !== String(id));
          saveItems();
          renderTable();
          // You can optionally sync to Power BI again here.
        });
      });
    }

    function addNewItem() {
      const newItem = {
        id: "i" + nextId++,
        name: "",
        dept: "",
        vendor_item: "",
        on_hand: "",
        par_level: "",
        on_order: "",
        vendor_status: "Normal",
        notes: "",
        photoData: ""
      };
      items.push(newItem);
      saveItems();
      renderTable();

      // Push new row to Power BI
      pushItemToPowerBI(newItem);
    }

    // =========================
    // 7 — INIT
    // =========================
    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderTable();

      document.getElementById("addItemButton").addEventListener("click", addNewItem);
      document.getElementById("resetButton").addEventListener("click", resetItems);
      document.getElementById("scannerCancelBtn").addEventListener("click", stopScan);

      const syncBtn = document.getElementById("syncAllPowerBIButton");
      if (syncBtn) {
        syncBtn.addEventListener("click", syncAllItemsToPowerBI);
      }

      const openReportBtn = document.getElementById("openReportButton");
      if (openReportBtn) {
        openReportBtn.addEventListener("click", openPowerBIReport);
      }

      // Once your embed token + IDs are real, uncomment this to show the embedded report:
      // embedPowerBIReport();
    });
  </script>
</body>
</html>
