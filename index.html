<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Providence Holy Cross – Overstock Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --ok-bg: #e8f5e9;
      --ok-text: #2e7d32;
      --ok-border: #2e7d32;

      --low-bg: #fff8e1;
      --low-text: #ff6f00;
      --low-border: #ff6f00;

      --over-bg: #ffebee;
      --over-text: #b71c1c;
      --over-border: #b71c1c;

      --card-bg: #ffffff;
      --card-border: #dde2eb;
      --table-header-bg: #f3f4f8;
      --body-bg: #f0f2f7;
      --primary: #1b4f72;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--body-bg);
      color: #222;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      color: var(--primary);
      font-size: 1.4rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 16px;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 320px 1fr;
        align-items: start;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--card-border);
      padding: 12px 14px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1rem;
      color: var(--primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 6px;
      border: 1px solid #c5cad5;
      padding: 6px 8px;
      font-size: 0.85rem;
      font-family: inherit;
      background: #fbfcff;
    }

    .form-group textarea {
      min-height: 48px;
      resize: vertical;
    }

    .form-inline {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      font-size: 0.78rem;
    }

    .hint {
      font-size: 0.7rem;
      color: #777;
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-secondary {
      background: #e0e3ec;
      color: #333;
    }

    .btn-danger {
      background: #b71c1c;
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      color: #555;
      border: 1px solid #c5cad5;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .filters select,
    .filters input {
      border-radius: 999px;
      border: 1px solid #c5cad5;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #fbfcff;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--card-border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #fff;
    }

    thead {
      background: var(--table-header-bg);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3ec;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .status-ok {
      background: var(--ok-bg);
      color: var(--ok-text);
      border-color: var(--ok-border);
    }

    .status-low {
      background: var(--low-bg);
      color: var(--low-text);
      border-color: var(--low-border);
    }

    .status-over {
      background: var(--over-bg);
      color: var(--over-text);
      border-color: var(--over-border);
    }

    .photo-thumb {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .no-photo {
      font-size: 0.7rem;
      color: #999;
    }

    .badge {
      font-size: 0.72rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #c5cad5;
      color: #555;
      background: #f8f9fd;
    }

    .count-label {
      font-size: 0.75rem;
      color: #777;
    }

    .actions button {
      padding: 4px 8px;
      font-size: 0.72rem;
    }

    .small-text {
      font-size: 0.7rem;
      color: #777;
      margin-top: 4px;
    }

    /* Simple full-screen image modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop img {
      max-width: 96vw;
      max-height: 96vh;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body>
  <h1>Providence Holy Cross – Overstock Tracker</h1>
  <div class="subtitle">
    Quickly log overstocked items by department, track quantities, and add photos from your phone.
  </div>

  <div class="layout">
    <!-- LEFT PANE – FORM -->
    <div class="card">
      <h2 id="form-title">Add New Item</h2>
      <div class="small-text">
        Fill this out while you're in the supply room. Data saves automatically to this device.
      </div>

      <form id="item-form">
        <input type="hidden" id="edit-index" value="" />

        <div class="form-grid">
          <div class="form-group">
            <label for="department">Department</label>
            <select id="department" required>
              <option value="">Select...</option>
              <option>2 SOUTH</option>
              <option>2 EAST</option>
              <option>3 NORTH</option>
              <option>ICU</option>
              <option>ED</option>
              <option>OR</option>
              <option>Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="location">Supply Location (Room/Shelf)</label>
            <input
              type="text"
              id="location"
              placeholder="e.g., Core A – Shelf 2"
            />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="item-name">Item Description</label>
            <input
              type="text"
              id="item-name"
              placeholder="e.g., 4x4 Gauze, 18G IV Catheter"
              required
            />
          </div>

          <div class="form-group">
            <label for="item-number">Vendor / Item # / Barcode</label>
            <input
              type="text"
              id="item-number"
              placeholder="Scan or type number"
            />
            <div class="hint">You can type the number or scan using your phone's camera app.</div>
          </div>

          <div class="form-group">
            <label for="quantity">Qty on Hand</label>
            <input
              type="number"
              id="quantity"
              min="0"
              placeholder="e.g., 45"
              required
            />
          </div>

          <div class="form-group">
            <label for="par-level">Target / PAR Qty</label>
            <input
              type="number"
              id="par-level"
              min="0"
              placeholder="e.g., 20"
              required
            />
            <div class="hint">Used to calculate LOW vs OVERSTOCK.</div>
          </div>

          <div class="form-group">
            <label for="expiration">Expiration Date (optional)</label>
            <input type="date" id="expiration" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="notes">Notes (optional)</label>
            <textarea
              id="notes"
              placeholder="e.g., Move to 2 EAST first, box slightly damaged, etc."
            ></textarea>
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="photo-input">Item Photo (optional)</label>
            <input
              type="file"
              id="photo-input"
              accept="image/*"
              capture="environment"
            />
            <div class="hint">
              On mobile, this will try to open the <strong>back camera</strong>.
              Take a quick photo of the box, label, or shelf.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn-primary" id="save-btn">
            <span>Save Item</span>
          </button>
          <button type="button" class="btn-secondary" id="clear-btn">
            Clear Form
          </button>
          <button type="button" class="btn-ghost" id="reset-all-btn">
            Reset All Data
          </button>
        </div>
      </form>
    </div>

    <!-- RIGHT PANE – TABLE -->
    <div class="card">
      <h2>Overstock List</h2>

      <div class="filters">
        <select id="filter-dept">
          <option value="">All Departments</option>
          <option>2 SOUTH</option>
          <option>2 EAST</option>
          <option>3 NORTH</option>
          <option>ICU</option>
          <option>ED</option>
          <option>OR</option>
          <option>Other</option>
        </select>

        <input
          type="text"
          id="search-text"
          placeholder="Search item, vendor #, notes..."
        />

        <span class="count-label">
          Items: <span id="item-count">0</span>
        </span>

        <button type="button" class="btn-ghost" id="export-btn">
          Export CSV
        </button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Dept</th>
              <th>Item</th>
              <th>Qty / PAR</th>
              <th>Status</th>
              <th>Photo</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="items-body">
            <!-- Rows injected here -->
          </tbody>
        </table>
      </div>

      <div class="small-text">
        Tip: you can use this page on your phone in the supply room, then open it
        on your desktop later – all data stays in this browser via localStorage.
      </div>
    </div>
  </div>

  <!-- SIMPLE IMAGE MODAL -->
  <div class="modal-backdrop" id="image-modal">
    <img id="modal-image" src="" alt="Item photo" />
  </div>

  <script>
    const STORAGE_KEY = "phc_overstock_items_v2";

    let items = [];
    let photoDataPending = null; // holds base64 image when selecting a photo

    // Load existing data
    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        items = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error loading items:", e);
        items = [];
      }
    }

    function saveItems() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function computeStatus(item) {
      const qty = Number(item.quantity || 0);
      const par = Number(item.parLevel || 0);

      if (!par && !qty) return { label: "OK", className: "status-ok" };
      if (par === 0) return { label: "OK", className: "status-ok" };

      if (qty < par) return { label: "LOW", className: "status-low" };
      if (qty > par) return { label: "OVERSTOCK", className: "status-over" };

      return { label: "OK", className: "status-ok" };
    }

    function applyFilters(baseItems) {
      const deptFilter = document.getElementById("filter-dept").value.trim();
      const searchText = document
        .getElementById("search-text")
        .value.trim()
        .toLowerCase();

      return baseItems.filter((item) => {
        if (deptFilter && item.department !== deptFilter) return false;

        if (searchText) {
          const blob = (
            (item.department || "") +
            " " +
            (item.itemName || "") +
            " " +
            (item.itemNumber || "") +
            " " +
            (item.notes || "") +
            " " +
            (item.location || "")
          )
            .toLowerCase()
            .includes(searchText);

          if (!blob) return false;
        }

        return true;
      });
    }

    function renderTable() {
      const tbody = document.getElementById("items-body");
      tbody.innerHTML = "";

      const filtered = applyFilters(items);
      document.getElementById("item-count").textContent = filtered.length;

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "No items logged yet.";
        td.style.textAlign = "center";
        td.style.color = "#777";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach((item, index) => {
        const tr = document.createElement("tr");

        // Dept
        const tdDept = document.createElement("td");
        tdDept.innerHTML = `
          <div>${item.department || ""}</div>
          <div class="small-text">${item.location || ""}</div>
        `;
        tr.appendChild(tdDept);

        // Item
        const tdItem = document.createElement("td");
        tdItem.innerHTML = `
          <div><strong>${item.itemName || ""}</strong></div>
          <div class="small-text">${item.itemNumber || ""}</div>
        `;
        tr.appendChild(tdItem);

        // Qty / PAR
        const tdQty = document.createElement("td");
        tdQty.innerHTML = `
          <div>${item.quantity ?? ""} / ${item.parLevel ?? ""}</div>
          ${
            item.expiration
              ? `<div class="small-text">Exp: ${item.expiration}</div>`
              : ""
          }
        `;
        tr.appendChild(tdQty);

        // Status
        const tdStatus = document.createElement("td");
        const { label, className } = computeStatus(item);
        const span = document.createElement("span");
        span.className = "status-pill " + className;
        span.textContent = label;
        tdStatus.appendChild(span);
        tr.appendChild(tdStatus);

        // Photo
        const tdPhoto = document.createElement("td");
        if (item.photoData) {
          const img = document.createElement("img");
          img.src = item.photoData;
          img.className = "photo-thumb";
          img.title = "Tap to enlarge";
          img.addEventListener("click", () => openPhotoModal(item.photoData));
          tdPhoto.appendChild(img);
        } else {
          const spanNo = document.createElement("span");
          spanNo.className = "no-photo";
          spanNo.textContent = "No photo";
          tdPhoto.appendChild(spanNo);
        }
        tr.appendChild(tdPhoto);

        // Notes
        const tdNotes = document.createElement("td");
        tdNotes.textContent = item.notes || "";
        tr.appendChild(tdNotes);

        // Actions
        const tdActions = document.createElement("td");
        tdActions.className = "actions";

        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn-secondary";
        btnEdit.textContent = "Edit";
        btnEdit.addEventListener("click", () => startEditItem(item.id));
        tdActions.appendChild(btnEdit);

        const btnDelete = document.createElement("button");
        btnDelete.type = "button";
        btnDelete.className = "btn-danger";
        btnDelete.style.marginLeft = "4px";
        btnDelete.textContent = "Del";
        btnDelete.addEventListener("click", () => deleteItem(item.id));
        tdActions.appendChild(btnDelete);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    function clearForm() {
      document.getElementById("item-form").reset();
      document.getElementById("edit-index").value = "";
      document.getElementById("form-title").textContent = "Add New Item";
      document.getElementById("save-btn").textContent = "Save Item";
      photoDataPending = null;
    }

    function handleSave(e) {
      e.preventDefault();

      const dept = document.getElementById("department").value.trim();
      const location = document.getElementById("location").value.trim();
      const itemName = document.getElementById("item-name").value.trim();
      const itemNumber = document
        .getElementById("item-number")
        .value.trim();
      const quantity = document.getElementById("quantity").value;
      const parLevel = document.getElementById("par-level").value;
      const expiration = document.getElementById("expiration").value;
      const notes = document.getElementById("notes").value.trim();

      if (!dept || !itemName || quantity === "" || parLevel === "") {
        alert("Department, Item, Qty on Hand, and PAR are required.");
        return;
      }

      const editId = document.getElementById("edit-index").value;
      const isEdit = editId !== "";

      const data = {
        id: isEdit ? editId : crypto.randomUUID(),
        department: dept,
        location,
        itemName,
        itemNumber,
        quantity: Number(quantity),
        parLevel: Number(parLevel),
        expiration: expiration || "",
        notes,
        photoData: photoDataPending ?? null,
        updatedAt: new Date().toISOString(),
      };

      if (isEdit) {
        const index = items.findIndex((i) => i.id === editId);
        if (index !== -1) {
          // Keep existing photo if we didn't select a new one
          if (photoDataPending === null) {
            data.photoData = items[index].photoData;
          }
          items[index] = data;
        }
      } else {
        items.push(data);
      }

      saveItems();
      clearForm();
      renderTable();
    }

    function startEditItem(id) {
      const item = items.find((i) => i.id === id);
      if (!item) return;

      document.getElementById("edit-index").value = item.id;
      document.getElementById("department").value = item.department || "";
      document.getElementById("location").value = item.location || "";
      document.getElementById("item-name").value = item.itemName || "";
      document.getElementById("item-number").value = item.itemNumber || "";
      document.getElementById("quantity").value = item.quantity ?? "";
      document.getElementById("par-level").value = item.parLevel ?? "";
      document.getElementById("expiration").value = item.expiration || "";
      document.getElementById("notes").value = item.notes || "";

      // Do not pre-fill file input; browser doesn't allow that.
      photoDataPending = null;

      document.getElementById("form-title").textContent = "Edit Item";
      document.getElementById("save-btn").textContent = "Save Changes";

      // Scroll up to form on mobile
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteItem(id) {
      if (!confirm("Delete this item?")) return;
      items = items.filter((i) => i.id !== id);
      saveItems();
      renderTable();
    }

    function resetAllData() {
      if (
        !confirm(
          "This will delete ALL overstock items stored in this browser. Continue?"
        )
      )
        return;

      items = [];
      saveItems();
      renderTable();
      clearForm();
    }

    function handlePhotoInput(e) {
      const file = e.target.files[0];
      if (!file) {
        photoDataPending = null;
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        photoDataPending = event.target.result; // base64 data URL
      };
      reader.readAsDataURL(file);
    }

    // Simple CSV export
    function exportCSV() {
      if (!items.length) {
        alert("No items to export.");
        return;
      }

      const headers = [
        "Department",
        "Location",
        "Item",
        "ItemNumber",
        "Quantity",
        "ParLevel",
        "Status",
        "Expiration",
        "Notes",
        "UpdatedAt",
      ];

      const rows = items.map((item) => {
        const status = computeStatus(item).label;
        return [
          item.department || "",
          item.location || "",
          item.itemName || "",
          item.itemNumber || "",
          item.quantity ?? "",
          item.parLevel ?? "",
          status,
          item.expiration || "",
          (item.notes || "").replace(/\r?\n/g, " "),
          item.updatedAt || "",
        ];
      });

      const csvContent = [headers.join(","), ...rows.map((r) => r.join(","))]
        .join("\n")
        .replace(/\uFEFF/g, "");

      const blob = new Blob(["\uFEFF" + csvContent], {
        type: "text/csv;charset=utf-8;",
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "phc_overstock.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Image modal
    function openPhotoModal(dataUrl) {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = dataUrl;
      modal.style.display = "flex";
    }

    function closePhotoModal() {
      const modal = document.getElementById("image-modal");
      const img = document.getElementById("modal-image");
      img.src = "";
      modal.style.display = "none";
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderTable();

      document
        .getElementById("item-form")
        .addEventListener("submit", handleSave);
      document
        .getElementById("clear-btn")
        .addEventListener("click", clearForm);
      document
        .getElementById("reset-all-btn")
        .addEventListener("click", resetAllData);
      document
        .getElementById("photo-input")
        .addEventListener("change", handlePhotoInput);
      document
        .getElementById("filter-dept")
        .addEventListener("change", renderTable);
      document
        .getElementById("search-text")
        .addEventListener("input", renderTable);
      document
        .getElementById("export-btn")
        .addEventListener("click", exportCSV);

      // Modal close
      const modal = document.getElementById("image-modal");
      modal.addEventListener("click", closePhotoModal);
    });
  </script>
</body>
</html>
